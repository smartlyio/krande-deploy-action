name: Build and release the action

on:
  push:
    branches: [master]

jobs:
  @import ./jobs/build

  @import ./jobs/test

  release:
    runs-on: <%= ubuntu_version %>
    name: "Build and release action"
    needs: [build, test]
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: build for release
        id: build
        run: |
          npm run all
          git_changes="$(git status --porcelain -- dist || true)"
            git add dist
            git commit -m "Update compiled action"
            echo ::set-output name=has_changes::true
          else
            echo ::set-output name=has_changes::false
          fi
      @import smartlyio/steps/util/get_next_semantic_version
      @import smartlyio/steps/util/check_branch_behind (is_base_ref: true, remote_update: true)
      - name: Create release
        if: steps.check_branch_behind.outputs.BRANCH_UP_TO_DATE=='true' && steps.version_check.continue_release=='true'
        run: |
          npm version ${{ steps.version_check.outputs.version }}
          git push && git push --tags
      - name: Commit changes without tag
        if: steps.check_branch_behind.outputs.BRANCH_UP_TO_DATE=='true' && steps.version_check.continue_release=='false' && steps.build.outputs.has_changes=='true'
        run: |
          git push
      - name: Update release branch
        if: steps.check_branch_behind.outputs.BRANCH_UP_TO_DATE=='true' && steps.version_check.continue_release=='true'
        run: |
          package_version="$(jq -r .version < package.json)"
          release_branch="v${package_version//.*/}"
          upstream="origin/${release_branch}"

          git checkout -b "${release_branch}"
          git branch --set-upstream-to="${upstream}"

          git push origin "${release_branch}"
